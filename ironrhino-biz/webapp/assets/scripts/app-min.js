(function(){Observation.app=function(b){$("form.report,a.report",b).attr("target","_blank");$("#report_format",b).children().click(function(){var a=$(this).data("format");$("a.report",b).attr("href",function(d,c){d=c.indexOf("format=");0<d&&(c=c.substring(0,d-1));return c+("&format="+a)});$("form.report",b).each(function(){var d=$('input[name="format"]',this);d.length?d.val(a):$(this).prepend('<input type="hidden" name="format" value="'+a+'"/>')})});$("#shipped,#paid",b).change(function(){var a=$("span.toggle",
$(this).closest(".controls"));$(this).is(":checked")?a.show():a.hide()});$("#customerName",b).blur(function(a){var d=$(a.target);(a=d.val())?$.ajax({url:CONTEXT_PATH+"/biz/customer/json/"+a,dataType:"json",success:function(a){var b=$('select[name="salesman.id"]',d.closest("form")),e=$('select[name="stationId"]',d.closest("form"));a&&a.id?(d.val(a.name).siblings("span.info").html(""),a.memo&&(a=$.parseJSON(a.memo),0>document.location.search.indexOf("salesman.id")&&(a.salesman?b.val(a.salesman):$("option:selected",
b).prop("selected",!1)),a.station?e.val(a.station):$("option:selected",e).prop("selected",!1))):(0>document.location.search.indexOf("salesman.id")&&$("option:selected",b).prop("selected",!1),$("option:selected",e).prop("selected",!1),d.siblings("span.info").text("\u81ea\u52a8\u4fdd\u5b58\u65b0\u5ba2\u6237"))}}):d.siblings("span.info").text("")});var e={};$(".customerName",b).autocomplete({minLength:2,source:function(a,b){a.term in e?b(e[a.term]):$.ajax({url:CONTEXT_PATH+"/biz/customer/suggest",dataType:"json",
data:a,success:function(c){e[a.term]=c;b(c)}})},select:function(a){$(a.target).siblings("span.info").html("")}});$("select.fetchprice",b).change(function(a){var b=$(a.target),c=$("input.price:eq(0)",b.closest("tr"));(a=b.val())&&!c.val()&&$.ajax({url:CONTEXT_PATH+"/biz/product/json/"+a,dataType:"json",success:function(a){a.price&&(c.val(a.price),f());0>=a.stock?b.siblings("span.info").html("\u6ca1\u6709\u5e93\u5b58"):b.siblings("span.info").html("")}})});$("#orderItems input.quantity",b).blur(function(a){f();
var b=$(a.target).val();if(b){var c=$("select.fetchprice",$(a.target).closest("tr"));(a=c.val())&&$.ajax({url:CONTEXT_PATH+"/biz/product/json/"+a,dataType:"json",success:function(a){$("input.price:eq(0)",c.closest("tr")).val(a.price||"");a.stock<b?c.siblings("span.info").html("\u5e93\u5b58\u4e0d\u591f"):c.siblings("span.info").html("")}})}});$("#orderItems .freegift",b).change(function(){var a=$("input.price",$(this).closest("tr"));if($(this).is(":checked"))a.data("oldvalue",a.val()).val("0.00").prop("readonly",
!0).next(".field-error").remove();else{var b=a.data("oldvalue");b?a.val(b):a.val("").focus();a.prop("readonly",!1)}f()});$("#orderItems input.price",b).blur(function(){var a=$(this).val();a&&$(".freegift",$(this).closest("tr")).prop("checked",0==parseFloat(a));f()});$("#discount,#freight",b).blur(function(){f()});$("#orderItems table",b).datagridTable({onremove:f});$("table.unpaid_order a.pay",b).each(function(){this.onsuccess=function(){$(this).closest("tr").remove();g()}})};var f=function(b){if(b){var e=
$("input.integer",b).val(),a=$("input.price",b).val(),d=0;e&&""!==a&&(d=e*a,$("td:eq(4) span.info",b).text(d.toFixed(2)));return d}var c=0;$("#orderItems tbody tr").each(function(){c+=f(this)});0<c&&$("#amount").text(c.toFixed(2));(b=$("#discount").val())&&(c-=parseFloat(b));b=$("#freight");b.val()&&(c=b.hasClass("add")?c+parseFloat(b.val()):c-parseFloat(b.val()));$("#grandTotal").html(0<=c?c.toFixed(2):'<span style="color:red;">\u8d1f\u6570</span>')},g=function(){var b=$("table.unpaid_order"),e=
0;$("tbody tr",b).each(function(){$("td:eq(3)",this).each(function(){e+=parseFloat($(this).text())})});$("tfoot td:eq(3)",b).text(e);return e}})();
