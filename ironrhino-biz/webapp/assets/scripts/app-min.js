(function(){function h(e,a){if(a=="xls")$(e).html("<span><span>\u5f53\u524d\u662fEXCEL,\u70b9\u51fb\u5207\u6362\u5230PDF</span></span>");else a=="pdf"&&$(e).html("<span><span>\u5f53\u524d\u662fPDF,\u70b9\u51fb\u5207\u6362\u5230EXCEL</span></span>");$("a.report").attr("href",function(c,b){c=b.indexOf("format=");if(c>0)b=b.substring(0,c-1);return b+("&format="+a)});$("form.report").each(function(){var c=$('input[name="format"]',this);c.length?c.val(a):$(this).prepend('<input type="hidden" name="format" value="'+
a+'"/>')})}Observation.app=function(){$("form.report").attr("target","_blank");$("#format").toggle(function(){h(this,"xls")},function(){h(this,"pdf")});$("#shipped,#paid").click(function(){var a=$(this).nextAll("span:eq(0)");$(this).attr("checked")?a.show():a.hide()});$("#customerName").blur(function(a){var c=$(a.target);(a=c.val())&&$.ajax({url:CONTEXT_PATH+"/biz/customer/json/"+a,dataType:"json",success:function(b){var d=$('select[name="salesman.id"]',c.closest("form")),g=$('select[name="stationId"]',
c.closest("form"));if(b&&b.id){c.val(b.name).siblings("span.info").html("");if(b.memo){b=$.parseJSON(b.memo);if(document.location.search.indexOf("salesman.id")<0)b.salesman?d.val(b.salesman):$("option:selected",d).removeAttr("selected");b.station?g.val(b.station):$("option:selected",g).removeAttr("selected")}}else{document.location.search.indexOf("salesman.id")<0&&$("option:selected",d).removeAttr("selected");$("option:selected",g).removeAttr("selected");c.siblings("span.info").html("\u5c06\u81ea\u52a8\u4fdd\u5b58\u4e3a\u65b0\u5ba2\u6237")}}})});
var e={};$(".customerName").autocomplete({minLength:2,source:function(a,c){a.term in e?c(e[a.term]):$.ajax({url:CONTEXT_PATH+"/biz/customer/suggest",dataType:"json",data:a,success:function(b){e[a.term]=b;c(b)}})},select:function(a){$(a.target).siblings("span.info").html("")}});$("select.fetchprice").change(function(a){var c=$(a.target),b=$("input.price:eq(0)",c.closest("tr"));(a=c.val())&&!b.val()&&$.ajax({url:CONTEXT_PATH+"/biz/product/json/"+a,dataType:"json",success:function(d){if(d.price){b.val(d.price);
f()}d.stock<=0?c.siblings("span.info").html("\u6ca1\u6709\u5e93\u5b58"):c.siblings("span.info").html("")}})});$("#orderItems input.quantity").blur(function(a){f();var c=$(a.target).val();if(c){var b=$("select.fetchprice",$(a.target).closest("tr"));(a=b.val())&&!b.siblings("span.info").text()&&$.ajax({url:CONTEXT_PATH+"/biz/product/json/"+a,dataType:"json",success:function(d){$("input.price:eq(0)",b.closest("tr")).val(d.price||"");d.stock<c&&b.siblings("span.info").html("\u5e93\u5b58\u4e0d\u591f")}})}});
$("#orderItems input.price,#discount,#freight").blur(function(){f()});$("#orderItems table").datagridTable({onremove:f})};var f=function(e){if(e){var a=$("input.integer",e).val(),c=$("input.double",e).val(),b=0;if(a&&c){b=a*c;$("td:eq(3) span.info",e).text(b)}return b}else{var d=0;$("#orderItems tbody tr").each(function(){d+=f(this)});d>0&&$("#amount").text(d);if(e=$("#discount").val())d-=e;if(e=$("#freight").val())d-=e;$("#grandTotal").html(d>=0?d:'<span style="color:red;">\u8d1f\u6570</span>')}}})();
